<!-- @format -->

<script>
  import {onMount, getContext} from 'svelte'

  import account from '../../components/etleneumAccountStore'
  import * as toast from '../../components/toast'
  import PayToCall from '../../components/PayToCall.html'

  const contract = getContext('contract')
  const kbaccounts = getContext('kbaccounts')

  onMount(loadOffers)

  var offers = []
  var creating = {satoshis: 1000, payload: {}}
  var call

  async function loadOffers() {
    try {
      offers = await contract.state(
        `.open | map_values(select(. > 0)) | map_values({desc, head, total: ((.bounty | map(.) | add)), voters, created_at}) | to_entries | map(.value.id = .key | .value) | sort_by(.created_at) | reverse`
      )
    } catch (err) {
      toast.error(`Failed to load open offers: ${err}`)
    }
  }

  async function create(e) {
    e.preventDefault()

    try {
      call = await contract.prepareCall(
        'create',
        parseInt(creating.satoshis) * 1000,
        creating.payload,
        $account.session
      )

      call.stop = contract.stream(
        id => {
          if (id === call.id) {
            toast.success('Bounty created!')
            call = null
            satoshis = 0
            setTimeout(call.stop, 1)
            loadBanner()
          }
        },
        (id, err) => {
          if (id === call.id) {
            toast.warning('Error: ' + err.message)
            setTimeout(call.stop, 1)
          }
        }
      )
    } catch (err) {
      toast.warning(`Failed to create bounty: ${err}`)
    }
  }

  function cancel() {
    call.stop()
    call = null
  }
</script>

<style>
  #offers a.title {
    display: block;
  }
  #offers em {
    color: var(--emphasis-rare);
  }
  #offers a.button {
    padding: 1px 3px;
    margin: 0 3px 0 -4px;
    display: inline-block;
    line-height: 0.5em;
    font-size: 87%;
    visibility: hidden;
  }
  #offers li:hover a.button {
    visibility: visible;
  }
  #offers em.voters {
    color: #6ea877;
  }
  #create {
    display: flex;
    flex-direction: column;
  }
  #create label {
    display: flex;
    margin-bottom: 16px;
    justify-content: space-between;
    align-items: center;
  }
  #create input,
  #create textarea {
    width: 50%;
    padding: 0 5px;
    margin: 0 5px;
  }
  #create button {
    margin: 16px 25%;
    padding: 10px;
    display: block;
  }
</style>

<div>
  {#if call}
  <PayToCall invoice="{call.invoice}" on:cancel="{cancel}" />
  {:else}
  <h2>Open offers</h2>
  <ul id="offers">
    {#each offers as offer}
    <li>
      <a class="title" href="#/{offer.id}">{offer.head}</a>
      <em>{parseInt(offer.total / 1000)} sat</em>
      <a class="button" href="#/{offer.id}">+</a> [<em class="voters"
        >{offer.voters.map(acct => acct in $kbaccounts ? $kbaccounts[acct] :
        acct).join(' ')}</em
      >] {(new Date(offer.created_at * 1000)).toISOString().split('T')[0]}
    </li>
    {/each}
  </ul>
  <h2>Create a bounty</h2>
  {#if $account}
  <form id="create" on:submit="{create}">
    <label>Task: <input bind:value="{creating.payload.head}"/></label>
    <label
      >Satoshis to offer:
      <input bind:value="{creating.satoshis}" type="number" />
    </label>
    <label>
      Detailed description:
      <textarea bind:value="{creating.payload.desc}"></textarea>
    </label>
    <button>Create</button>
  </form>
  {:else}
  <p>Login to be able to create a bounty!</p>
  {/if} {/if}
</div>
